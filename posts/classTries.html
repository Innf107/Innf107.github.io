<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Blazingly Fastâ„¢ Type Class Resolution with Tries</title>
    <meta name=viewport content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="Blazingly Fastâ„¢ Type Class Resolution with Tries">
    <meta property="og:site_name" content="Prophetlabs">
    <meta property="og:description" content="Blazingly Fastâ„¢ Type Class Resolution with Tries">
    <meta property="twitter:title" content="Blazingly Fastâ„¢ Type Class Resolution with Tries">
    <meta property="twitter:description" content="Blazingly Fastâ„¢ Type Class Resolution with Tries">
    <meta property="twitter:url" content="https://prophetlabs.de/posts/classTries.html">
    <meta property="twitter:type" content="summary">
    <meta property="twitter:domain" content="prophetlabs.de">
    <meta name="twitter:card" content="summary_large_image">
            <!--Fonts-->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Fira+Code&family=Poppins:wght@400;700&display=swap" rel="stylesheet"> 
        <link rel="stylesheet" type="text/css" href="/assets/post.css">

        <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml">

        <!--Icons-->
        <script src="https://kit.fontawesome.com/e4faccddf2.js" crossorigin="anonymous"></script>

    

    <!--KaTeX-->
<link defer rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css"
    integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"
    integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja"
    crossorigin="anonymous"></script>
<!-- Mostly Generated by pandoc -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var mathElements = document.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
            var texText = mathElements[i].firstChild;
            if (mathElements[i].tagName == "SPAN") {
                katex.render(texText.data, mathElements[i], {
                    displayMode: mathElements[i].classList.contains('display'),
                    throwOnError: false,
                    macros: macros,
                    fleqn: false
                });
            }
        }

        // replace KaTeX colors with CSS variables so that we can control them in light/dark mode
        document.querySelectorAll(".mrel").forEach(element => {
            if (element.style.color == "blue") {
                element.style.color = "var(--katex-blue)"
            } else if (element.style.color == "red") {
                element.style.color = "var(--katex-red)"
            } else if (element.style.color == "purple") {
                element.style.color = "var(--katex-purple)"
            }
        })

        // replace Â¤ characters in source code with '.diff-area' spans and add a '.diff' class to the 
        // corresponding pre element to adjust the style correctly.
        // Ideally this would be done at compile time, but that's more difficult and will not work for katex segments.
        document.querySelectorAll("pre.sourceCode").forEach(pre => {
            let html = pre.innerHTML

            if (!/Â¤/.test(html)) {
                // This code block is not a diff block
                return
            }

            let matchingClosing = false
            while (/Â¤/.test(html)) {
                if (!matchingClosing) {
                    html = html.replace(/Â¤/, "<span class='diff-area'>")
                } else {
                    html = html.replace(/Â¤/, "</span>")
                }

                matchingClosing = !matchingClosing
            }
            if (matchingClosing) {
                console.error("unmatched diff block in source code", pre)
                return
            }

            pre.innerHTML = html
            pre.classList.add("diff")
        })
    })
</script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        function reflowGrids() {
            document.querySelectorAll(".grid.parent").forEach(parent => {
                parent.classList.remove("column1")
                let hasOverflow = false
                for (child of parent.children) {
                    // We need to check grandchildren because of how overflow is set up for
                    // code elements
                    for (grandchild of child.children) {
                        // check for horizontal overflow
                        if (grandchild.scrollWidth > grandchild.clientWidth) {
                            hasOverflow = true
                            break
                        }
                    }
                    // Ugh, just give me labelled break
                    if (hasOverflow) {
                        break
                    }
                }
                if (hasOverflow) {
                    parent.classList.add("column1")
                } else {
                    parent.classList.remove("column1")
                }
            })
        }
        reflowGrids()
        window.addEventListener("resize", reflowGrids)
    })
</script>

</head>

<body>
    <header>
    <nav class="navbar">
        <div class="navigation left">
            <a href="/" class="header">Prophetlabs</a>
        </div>
        
        <div class="navigation middle">
        </div>
        <div class="navigation right">
            <button class="dark-mode" onclick="toggleDarkMode()">
                <i id="dark-mode-dark" class="fa-regular fa-moon"></i>
                <span id="dark-mode-light">ðŸ”†</span>
            </button>
            <a href="/about.html">About</a>
        </div>
    </nav>
</header>
    <article>
        <h1>Blazingly Fastâ„¢ Type Class Resolution with Tries</h1>
        <span class="date">19 February 2024</span>
        <p>One of the more fundamental hurdles when implementing type classes is
instance resolution. A programmer might write any possible number of
instances for a given class, so how do we find the one we are looking
for?</p>
<p>For the remaining examples, letâ€™s assume that our program contains
the following instances</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode hs"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">C</span>(a)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">C</span>(<span class="dt">Int</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">C</span>(<span class="dt">List</span>(<span class="dt">Bool</span>))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">C</span>(<span class="dt">List</span>(<span class="dt">String</span>))</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="kw">forall</span> a<span class="op">.</span> <span class="dt">C</span>((a, <span class="dt">Int</span>))</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="kw">forall</span> a<span class="op">.</span> <span class="dt">C</span>((<span class="dt">Bool</span>, a))</span></code></pre></div>
<p>Now, the easiest way to find an instance for a constraint, say
<code>C((String, Int))</code>, is to linearly search through every
single instance until one matches the constraint arguments.</p>
<p>For example, in this case, we would try (and fail) to match every
single instance until we hit <code>forall a. C((a, Int))</code>.</p>
<p>Somewhat surprisingly, this is actually the strategy GHC uses.<a
href="#fn1" class="footnote-ref" id="fnref1"
role="doc-noteref"><sup>1</sup></a> But with a large number of
instances, this is not exactly efficient and as it turns out, with a
little effort, we can do much better!</p>
<h2 id="we-need-to-trie-hardersorry">We need to trie harder<a
href="#fn2" class="footnote-ref" id="fnref2"
role="doc-noteref"><sup>2</sup></a></h2>
<p>If you already know what tries are, the context in which you learned
about them was probably very different.</p>
<p>The traditional use case for tries is matching sequences of text. The
prime example here is text auto-completion. Imagine that our set of
valid words consists of
<code>["dog", "cat", "car", "candle",  "dune", "can", "current", "dose", "bat", "category"]</code>
and the user has typed in <code>"cat"</code>. How do we find the set of
valid completions?</p>
<p>Just like above, we could linearly walk through the set of valid
words and pick out all the ones that contain the prefix
<code>cat</code>. For reasons that will become apparent soon, we can
visualize this flat set of all valid words as a flat tree.</p>
<div class="dot-output">
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Generated by graphviz version 9.0.0 (0)
 -->
<!-- Pages: 1 -->
<svg width="886pt" height="116pt" viewBox="0.00 0.00 885.53 116.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 112)">
<g id="node1" class="node">
<title>
</title>
<ellipse fill="none"  cx="404.64" cy="-90" rx="27" ry="18"/> </g>
<!-- dog --> <g id="node2" class="node">
<title>
dog
</title>
<ellipse fill="none"  cx="29.64" cy="-18" rx="29.64" ry="18"/>
<text text-anchor="middle" x="29.64" y="-13.32" font-family="Times,serif" font-size="14.00">dog</text>
</g> <!-- &#45;&gt;dog --> <g id="edge1" class="edge">
<title>
-&gt;dog
</title>
<path fill="none"  d="M377.56,-87.08C319.79,-82.47 180.61,-68.65 68.64,-36 66.79,-35.46 64.9,-34.85 63.02,-34.2"/>
<polygon   points="64.37,-30.97 53.78,-30.61 61.84,-37.49 64.37,-30.97"/>
</g> <!-- cat --> <g id="node3" class="node">
<title>
cat
</title>
<ellipse fill="none"  cx="104.64" cy="-18" rx="27" ry="18"/>
<text text-anchor="middle" x="104.64" y="-13.32" font-family="Times,serif" font-size="14.00">cat</text>
</g> <!-- &#45;&gt;cat --> <g id="edge2" class="edge">
<title>
-&gt;cat
</title>
<path fill="none"  d="M377.86,-85.81C329.54,-79.59 224.96,-63.91 140.64,-36 139.08,-35.48 137.5,-34.92 135.92,-34.31"/>
<polygon   points="137.57,-31.21 127,-30.54 134.84,-37.66 137.57,-31.21"/>
</g> <!-- car --> <g id="node4" class="node">
<title>
car
</title>
<ellipse fill="none"  cx="176.64" cy="-18" rx="27.01" ry="18"/>
<text text-anchor="middle" x="176.64" y="-13.32" font-family="Times,serif" font-size="14.00">car</text>
</g> <!-- &#45;&gt;car --> <g id="edge3" class="edge">
<title>
-&gt;car
</title>
<path fill="none"  d="M379.04,-83.41C341.81,-74.96 270.83,-57.59 212.64,-36 211.1,-35.43 209.54,-34.82 207.97,-34.18"/>
<polygon   points="209.65,-31.09 199.08,-30.29 206.84,-37.51 209.65,-31.09"/>
</g> <!-- candle --> <g id="node5" class="node">
<title>
candle
</title>
<ellipse fill="none"  cx="265.64" cy="-18" rx="43.84" ry="18"/>
<text text-anchor="middle" x="265.64" y="-13.32" font-family="Times,serif" font-size="14.00">candle</text>
</g> <!-- &#45;&gt;candle --> <g id="edge4" class="edge">
<title>
-&gt;candle
</title>
<path fill="none"  d="M383.53,-78.37C362.17,-67.61 328.7,-50.76 302.87,-37.75"/>
<polygon   points="304.54,-34.67 294.04,-33.3 301.39,-40.93 304.54,-34.67"/>
</g> <!-- dune --> <g id="node6" class="node">
<title>
dune
</title>
<ellipse fill="none"  cx="363.64" cy="-18" rx="35.95" ry="18"/>
<text text-anchor="middle" x="363.64" y="-13.32" font-family="Times,serif" font-size="14.00">dune</text>
</g> <!-- &#45;&gt;dune --> <g id="edge5" class="edge">
<title>
-&gt;dune
</title>
<path fill="none"  d="M395.13,-72.76C390.38,-64.67 384.53,-54.66 379.15,-45.49"/>
<polygon   points="382.22,-43.8 374.14,-36.94 376.18,-47.34 382.22,-43.8"/>
</g> <!-- can --> <g id="node7" class="node">
<title>
can
</title>
<ellipse fill="none"  cx="446.64" cy="-18" rx="28.59" ry="18"/>
<text text-anchor="middle" x="446.64" y="-13.32" font-family="Times,serif" font-size="14.00">can</text>
</g> <!-- &#45;&gt;can --> <g id="edge6" class="edge">
<title>
-&gt;can
</title>
<path fill="none"  d="M414.38,-72.76C419.36,-64.46 425.55,-54.15 431.16,-44.79"/>
<polygon   points="434.03,-46.82 436.17,-36.45 428.02,-43.22 434.03,-46.82"/>
</g> <!-- current --> <g id="node8" class="node">
<title>
current
</title>
<ellipse fill="none"  cx="541.64" cy="-18" rx="48.58" ry="18"/>
<text text-anchor="middle" x="541.64" y="-13.32" font-family="Times,serif" font-size="14.00">current</text>
</g> <!-- &#45;&gt;current --> <g id="edge7" class="edge">
<title>
-&gt;current
</title>
<path fill="none"  d="M425.74,-78.22C446.59,-67.56 478.92,-51.04 504.14,-38.16"/>
<polygon   points="505.46,-41.42 512.77,-33.75 502.27,-35.18 505.46,-41.42"/>
</g> <!-- dose --> <g id="node9" class="node">
<title>
dose
</title>
<ellipse fill="none"  cx="642.64" cy="-18" rx="34.37" ry="18"/>
<text text-anchor="middle" x="642.64" y="-13.32" font-family="Times,serif" font-size="14.00">dose</text>
</g> <!-- &#45;&gt;dose --> <g id="edge8" class="edge">
<title>
-&gt;dose
</title>
<path fill="none"  d="M429.84,-83.1C467.25,-74.13 539.55,-55.98 599.64,-36 601.61,-35.34 603.62,-34.65 605.64,-33.93"/>
<polygon   points="606.87,-37.2 615.01,-30.43 604.42,-30.65 606.87,-37.2"/>
</g> <!-- bat --> <g id="node10" class="node">
<title>
bat
</title>
<ellipse fill="none"  cx="722.64" cy="-18" rx="27.53" ry="18"/>
<text text-anchor="middle" x="722.64" y="-13.32" font-family="Times,serif" font-size="14.00">bat</text>
</g> <!-- &#45;&gt;bat --> <g id="edge9" class="edge">
<title>
-&gt;bat
</title>
<path fill="none"  d="M431.52,-86.15C482.17,-80.29 594.82,-64.95 685.64,-36 687.36,-35.45 689.11,-34.84 690.86,-34.19"/>
<polygon   points="692.17,-37.44 700.07,-30.38 689.49,-30.97 692.17,-37.44"/>
</g> <!-- category --> <g id="node11" class="node">
<title>
category
</title>
<ellipse fill="none"  cx="822.64" cy="-18" rx="54.89" ry="18"/>
<text text-anchor="middle" x="822.64" y="-13.32" font-family="Times,serif" font-size="14.00">category</text>
</g> <!-- &#45;&gt;category --> <g id="edge10" class="edge">
<title>
-&gt;category
</title>
<path fill="none"  d="M431.1,-86.11C490.33,-79.41 637.94,-61.41 759.64,-36 763.47,-35.2 767.41,-34.31 771.37,-33.36"/>
<polygon   points="772.16,-36.77 781.01,-30.95 770.46,-29.98 772.16,-36.77"/>
</g> </g>
</svg>
</div>
<p>This is obviously pretty inefficient. If you were to try and optimize
this, you might try the following: All words that contain the prefix
<code>cat</code> start with a <code>c</code>, so we can group our words
by their first character to immediately filter out all the ones that
donâ€™t start with a <code>c</code>.</p>
<p>With this optimization, our tree, now represented as a map from
characters to sets of words, looks like this.</p>
<div class="dot-output">
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Generated by graphviz version 9.0.0 (0)
 -->
<!-- Pages: 1 -->
<svg width="883pt" height="188pt" viewBox="0.00 0.00 883.17 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<g id="node1" class="node">
<title>
</title>
<ellipse fill="none"  cx="486.64" cy="-162" rx="27" ry="18"/> </g>
<!-- d --> <g id="node2" class="node">
<title>
d
</title>
<ellipse fill="none"  cx="157.64" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="157.64" y="-85.33" font-family="Times,serif" font-size="14.00">d</text>
</g> <!-- &#45;&gt;d --> <g id="edge1" class="edge">
<title>
-&gt;d
</title>
<path fill="none"  d="M461.1,-155.57C403.15,-143.24 261.56,-113.11 194.29,-98.8"/>
<polygon   points="195.38,-95.45 184.87,-96.79 193.92,-102.3 195.38,-95.45"/>
</g> <!-- c --> <g id="node3" class="node">
<title>
c
</title>
<ellipse fill="none"  cx="486.64" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="486.64" y="-85.33" font-family="Times,serif" font-size="14.00">c</text>
</g> <!-- &#45;&gt;c --> <g id="edge2" class="edge">
<title>
-&gt;c
</title>
<path fill="none"  d="M486.64,-143.7C486.64,-136.41 486.64,-127.73 486.64,-119.54"/>
<polygon   points="490.14,-119.62 486.64,-109.62 483.14,-119.62 490.14,-119.62"/>
</g> <!-- b --> <g id="node4" class="node">
<title>
b
</title>
<ellipse fill="none"  cx="725.64" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="725.64" y="-85.33" font-family="Times,serif" font-size="14.00">b</text>
</g> <!-- &#45;&gt;b --> <g id="edge3" class="edge">
<title>
-&gt;b
</title>
<path fill="none"  d="M510.87,-153.9C553.28,-141.48 641.11,-115.76 690.3,-101.35"/>
<polygon   points="691.28,-104.71 699.89,-98.54 689.31,-97.99 691.28,-104.71"/>
</g> <!-- dog --> <g id="node5" class="node">
<title>
dog
</title>
<ellipse fill="none"  cx="29.64" cy="-18" rx="29.64" ry="18"/>
<text text-anchor="middle" x="29.64" y="-13.32" font-family="Times,serif" font-size="14.00">dog</text>
</g> <!-- d&#45;&gt;dog --> <g id="edge4" class="edge">
<title>
d-&gt;dog
</title>
<path fill="none"  d="M137.07,-77.75C116.51,-66.51 84.63,-49.07 60.93,-36.11"/>
<polygon   points="62.79,-33.14 52.33,-31.41 59.43,-39.28 62.79,-33.14"/>
</g> <!-- dune --> <g id="node9" class="node">
<title>
dune
</title>
<ellipse fill="none"  cx="113.64" cy="-18" rx="35.95" ry="18"/>
<text text-anchor="middle" x="113.64" y="-13.32" font-family="Times,serif" font-size="14.00">dune</text>
</g> <!-- d&#45;&gt;dune --> <g id="edge5" class="edge">
<title>
d-&gt;dune
</title>
<path fill="none"  d="M147.65,-73.12C142.44,-64.82 135.93,-54.46 130,-45.03"/>
<polygon   points="132.98,-43.19 124.69,-36.59 127.05,-46.92 132.98,-43.19"/>
</g> <!-- dose --> <g id="node12" class="node">
<title>
dose
</title>
<ellipse fill="none"  cx="201.64" cy="-18" rx="34.37" ry="18"/>
<text text-anchor="middle" x="201.64" y="-13.32" font-family="Times,serif" font-size="14.00">dose</text>
</g> <!-- d&#45;&gt;dose --> <g id="edge6" class="edge">
<title>
d-&gt;dose
</title>
<path fill="none"  d="M167.62,-73.12C172.84,-64.82 179.35,-54.46 185.27,-45.03"/>
<polygon   points="188.22,-46.92 190.58,-36.59 182.3,-43.19 188.22,-46.92"/>
</g> <!-- cat --> <g id="node6" class="node">
<title>
cat
</title>
<ellipse fill="none"  cx="280.64" cy="-18" rx="27" ry="18"/>
<text text-anchor="middle" x="280.64" y="-13.32" font-family="Times,serif" font-size="14.00">cat</text>
</g> <!-- c&#45;&gt;cat --> <g id="edge7" class="edge">
<title>
c-&gt;cat
</title>
<path fill="none"  d="M461.78,-82.42C428.32,-73.3 367.19,-55.71 316.64,-36 315.11,-35.4 313.55,-34.77 311.99,-34.12"/>
<polygon   points="313.69,-31.04 303.13,-30.18 310.85,-37.44 313.69,-31.04"/>
</g> <!-- car --> <g id="node7" class="node">
<title>
car
</title>
<ellipse fill="none"  cx="352.64" cy="-18" rx="27.01" ry="18"/>
<text text-anchor="middle" x="352.64" y="-13.32" font-family="Times,serif" font-size="14.00">car</text>
</g> <!-- c&#45;&gt;car --> <g id="edge8" class="edge">
<title>
c-&gt;car
</title>
<path fill="none"  d="M465.7,-78.06C443.67,-66.56 408.77,-48.32 383.57,-35.16"/>
<polygon   points="385.25,-32.09 374.77,-30.56 382.01,-38.29 385.25,-32.09"/>
</g> <!-- candle --> <g id="node8" class="node">
<title>
candle
</title>
<ellipse fill="none"  cx="441.64" cy="-18" rx="43.84" ry="18"/>
<text text-anchor="middle" x="441.64" y="-13.32" font-family="Times,serif" font-size="14.00">candle</text>
</g> <!-- c&#45;&gt;candle --> <g id="edge9" class="edge">
<title>
c-&gt;candle
</title>
<path fill="none"  d="M476.43,-73.12C471.17,-64.94 464.62,-54.76 458.63,-45.44"/>
<polygon   points="461.61,-43.59 453.25,-37.07 455.72,-47.37 461.61,-43.59"/>
</g> <!-- can --> <g id="node10" class="node">
<title>
can
</title>
<ellipse fill="none"  cx="531.64" cy="-18" rx="28.59" ry="18"/>
<text text-anchor="middle" x="531.64" y="-13.32" font-family="Times,serif" font-size="14.00">can</text>
</g> <!-- c&#45;&gt;can --> <g id="edge10" class="edge">
<title>
c-&gt;can
</title>
<path fill="none"  d="M496.85,-73.12C502.31,-64.61 509.18,-53.94 515.36,-44.32"/>
<polygon   points="518.18,-46.4 520.65,-36.09 512.3,-42.61 518.18,-46.4"/>
</g> <!-- current --> <g id="node11" class="node">
<title>
current
</title>
<ellipse fill="none"  cx="626.64" cy="-18" rx="48.58" ry="18"/>
<text text-anchor="middle" x="626.64" y="-13.32" font-family="Times,serif" font-size="14.00">current</text>
</g> <!-- c&#45;&gt;current --> <g id="edge11" class="edge">
<title>
c-&gt;current
</title>
<path fill="none"  d="M507.9,-78.37C529.15,-67.75 562.28,-51.18 588.15,-38.24"/>
<polygon   points="589.65,-41.41 597.03,-33.8 586.52,-35.14 589.65,-41.41"/>
</g> <!-- category --> <g id="node14" class="node">
<title>
category
</title>
<ellipse fill="none"  cx="747.64" cy="-18" rx="54.89" ry="18"/>
<text text-anchor="middle" x="747.64" y="-13.32" font-family="Times,serif" font-size="14.00">category</text>
</g> <!-- c&#45;&gt;category --> <g id="edge12" class="edge">
<title>
c-&gt;category
</title>
<path fill="none"  d="M511.65,-82.32C549.21,-72.29 622.44,-52.72 684.64,-36 688.14,-35.06 691.75,-34.09 695.39,-33.11"/>
<polygon   points="696.09,-36.54 704.84,-30.56 694.27,-29.78 696.09,-36.54"/>
</g> <!-- bat --> <g id="node13" class="node">
<title>
bat
</title>
<ellipse fill="none"  cx="847.64" cy="-18" rx="27.53" ry="18"/>
<text text-anchor="middle" x="847.64" y="-13.32" font-family="Times,serif" font-size="14.00">bat</text>
</g> <!-- b&#45;&gt;bat --> <g id="edge13" class="edge">
<title>
b-&gt;bat
</title>
<path fill="none"  d="M745.78,-77.44C765.3,-66.24 795.14,-49.12 817.48,-36.3"/>
<polygon   points="819.22,-39.34 826.15,-31.33 815.73,-33.27 819.22,-39.34"/>
</g> </g>
</svg>
</div>
<p>Cool! This already cut the number of words we need to search through
roughly in half. To speed things up further, you might notice that
exactly the same argument applies to the second character, as well as
the third, fourth, and every one after that!</p>
<p>So if we apply this optimization to <em>every</em> character,
effectively unrolling the words into fancy interlinked lists of
characters, we end up with a <strong>trie</strong>!</p>
<div class="dot-output">
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Generated by graphviz version 9.0.0 (0)
 -->
<!-- Pages: 1 -->
<svg width="566pt" height="620pt" viewBox="0.00 0.00 566.00 620.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 616)">
<g id="node1" class="node">
<title>
</title>
<ellipse fill="none"  cx="369" cy="-594" rx="27" ry="18"/> </g>
<!-- d --> <g id="node2" class="node">
<title>
d
</title>
<ellipse fill="none"  cx="171" cy="-522" rx="27" ry="18"/>
<text text-anchor="middle" x="171" y="-517.33" font-family="Times,serif" font-size="14.00">d</text>
</g> <!-- &#45;&gt;d --> <g id="edge1" class="edge">
<title>
-&gt;d
</title>
<path fill="none"  d="M345.51,-584.7C310.75,-572.41 245.42,-549.31 205.3,-535.13"/>
<polygon   points="206.48,-531.83 195.89,-531.8 204.15,-538.43 206.48,-531.83"/>
</g> <!-- c --> <g id="node3" class="node">
<title>
c
</title>
<ellipse fill="none"  cx="369" cy="-522" rx="27" ry="18"/>
<text text-anchor="middle" x="369" y="-517.33" font-family="Times,serif" font-size="14.00">c</text>
</g> <!-- &#45;&gt;c --> <g id="edge2" class="edge">
<title>
-&gt;c
</title>
<path fill="none"  d="M369,-575.7C369,-568.41 369,-559.73 369,-551.54"/>
<polygon   points="372.5,-551.62 369,-541.62 365.5,-551.62 372.5,-551.62"/>
</g> <!-- b --> <g id="node4" class="node">
<title>
b
</title>
<ellipse fill="none"  cx="481" cy="-522" rx="27" ry="18"/>
<text text-anchor="middle" x="481" y="-517.33" font-family="Times,serif" font-size="14.00">b</text>
</g> <!-- &#45;&gt;b --> <g id="edge3" class="edge">
<title>
-&gt;b
</title>
<path fill="none"  d="M388.25,-580.97C405.8,-570 431.97,-553.64 452.04,-541.1"/>
<polygon   points="453.71,-544.18 460.34,-535.91 450,-538.24 453.71,-544.18"/>
</g> <!-- do --> <g id="node5" class="node">
<title>
do
</title>
<ellipse fill="none"  cx="99" cy="-450" rx="27" ry="18"/>
<text text-anchor="middle" x="99" y="-445.32" font-family="Times,serif" font-size="14.00">o</text>
</g> <!-- d&#45;&gt;do --> <g id="edge4" class="edge">
<title>
d-&gt;do
</title>
<path fill="none"  d="M156.08,-506.5C146.23,-496.92 133.14,-484.19 121.97,-473.34"/>
<polygon   points="124.59,-471 114.98,-466.54 119.71,-476.02 124.59,-471"/>
</g> <!-- du --> <g id="node9" class="node">
<title>
du
</title>
<ellipse fill="none"  cx="171" cy="-450" rx="27" ry="18"/>
<text text-anchor="middle" x="171" y="-445.32" font-family="Times,serif" font-size="14.00">u</text>
</g> <!-- d&#45;&gt;du --> <g id="edge8" class="edge">
<title>
d-&gt;du
</title>
<path fill="none"  d="M171,-503.7C171,-496.41 171,-487.73 171,-479.54"/>
<polygon   points="174.5,-479.62 171,-469.62 167.5,-479.62 174.5,-479.62"/>
</g> <!-- ca --> <g id="node12" class="node">
<title>
ca
</title>
<ellipse fill="none"  cx="324" cy="-450" rx="27" ry="18"/>
<text text-anchor="middle" x="324" y="-445.32" font-family="Times,serif" font-size="14.00">a</text>
</g> <!-- c&#45;&gt;ca --> <g id="edge11" class="edge">
<title>
c-&gt;ca
</title>
<path fill="none"  d="M358.79,-505.12C353.32,-496.61 346.46,-485.94 340.28,-476.32"/>
<polygon   points="343.34,-474.61 334.99,-468.09 337.45,-478.4 343.34,-474.61"/>
</g> <!-- cu --> <g id="node24" class="node">
<title>
cu
</title>
<ellipse fill="none"  cx="414" cy="-450" rx="27" ry="18"/>
<text text-anchor="middle" x="414" y="-445.32" font-family="Times,serif" font-size="14.00">u</text>
</g> <!-- c&#45;&gt;cu --> <g id="edge23" class="edge">
<title>
c-&gt;cu
</title>
<path fill="none"  d="M379.21,-505.12C384.68,-496.61 391.54,-485.94 397.72,-476.32"/>
<polygon   points="400.55,-478.4 403.01,-468.09 394.66,-474.61 400.55,-478.4"/>
</g> <!-- ba --> <g id="node30" class="node">
<title>
ba
</title>
<ellipse fill="none"  cx="522" cy="-450" rx="27" ry="18"/>
<text text-anchor="middle" x="522" y="-445.32" font-family="Times,serif" font-size="14.00">a</text>
</g> <!-- b&#45;&gt;ba --> <g id="edge29" class="edge">
<title>
b-&gt;ba
</title>
<path fill="none"  d="M490.51,-504.76C495.37,-496.46 501.41,-486.15 506.89,-476.79"/>
<polygon   points="509.74,-478.85 511.78,-468.45 503.7,-475.31 509.74,-478.85"/>
</g> <!-- dog --> <g id="node6" class="node">
<title>
dog
</title>
<ellipse fill="none"  cx="27" cy="-378" rx="27" ry="18"/>
<text text-anchor="middle" x="27" y="-373.32" font-family="Times,serif" font-size="14.00">g</text>
</g> <!-- do&#45;&gt;dog --> <g id="edge5" class="edge">
<title>
do-&gt;dog
</title>
<path fill="none"  d="M84.08,-434.5C74.23,-424.92 61.14,-412.19 49.97,-401.34"/>
<polygon   points="52.59,-399 42.98,-394.54 47.71,-404.02 52.59,-399"/>
</g> <!-- dos --> <g id="node7" class="node">
<title>
dos
</title>
<ellipse fill="none"  cx="99" cy="-378" rx="27" ry="18"/>
<text text-anchor="middle" x="99" y="-373.32" font-family="Times,serif" font-size="14.00">s</text>
</g> <!-- do&#45;&gt;dos --> <g id="edge6" class="edge">
<title>
do-&gt;dos
</title>
<path fill="none"  d="M99,-431.7C99,-424.41 99,-415.73 99,-407.54"/>
<polygon   points="102.5,-407.62 99,-397.62 95.5,-407.62 102.5,-407.62"/>
</g> <!-- dose --> <g id="node8" class="node">
<title>
dose
</title>
<ellipse fill="none"  cx="99" cy="-306" rx="27" ry="18"/>
<text text-anchor="middle" x="99" y="-301.32" font-family="Times,serif" font-size="14.00">e</text>
</g> <!-- dos&#45;&gt;dose --> <g id="edge7" class="edge">
<title>
dos-&gt;dose
</title>
<path fill="none"  d="M99,-359.7C99,-352.41 99,-343.73 99,-335.54"/>
<polygon   points="102.5,-335.62 99,-325.62 95.5,-335.62 102.5,-335.62"/>
</g> <!-- dun --> <g id="node10" class="node">
<title>
dun
</title>
<ellipse fill="none"  cx="171" cy="-378" rx="27" ry="18"/>
<text text-anchor="middle" x="171" y="-373.32" font-family="Times,serif" font-size="14.00">n</text>
</g> <!-- du&#45;&gt;dun --> <g id="edge9" class="edge">
<title>
du-&gt;dun
</title>
<path fill="none"  d="M171,-431.7C171,-424.41 171,-415.73 171,-407.54"/>
<polygon   points="174.5,-407.62 171,-397.62 167.5,-407.62 174.5,-407.62"/>
</g> <!-- dune --> <g id="node11" class="node">
<title>
dune
</title>
<ellipse fill="none"  cx="171" cy="-306" rx="27" ry="18"/>
<text text-anchor="middle" x="171" y="-301.32" font-family="Times,serif" font-size="14.00">e</text>
</g> <!-- dun&#45;&gt;dune --> <g id="edge10" class="edge">
<title>
dun-&gt;dune
</title>
<path fill="none"  d="M171,-359.7C171,-352.41 171,-343.73 171,-335.54"/>
<polygon   points="174.5,-335.62 171,-325.62 167.5,-335.62 174.5,-335.62"/>
</g> <!-- cat --> <g id="node13" class="node">
<title>
cat
</title>
<ellipse fill="none"  cx="243" cy="-378" rx="27" ry="18"/>
<text text-anchor="middle" x="243" y="-373.32" font-family="Times,serif" font-size="14.00">t</text>
</g> <!-- ca&#45;&gt;cat --> <g id="edge12" class="edge">
<title>
ca-&gt;cat
</title>
<path fill="none"  d="M308,-435.17C296.46,-425.2 280.67,-411.56 267.55,-400.21"/>
<polygon   points="269.97,-397.68 260.11,-393.79 265.39,-402.98 269.97,-397.68"/>
</g> <!-- car --> <g id="node19" class="node">
<title>
car
</title>
<ellipse fill="none"  cx="315" cy="-378" rx="27" ry="18"/>
<text text-anchor="middle" x="315" y="-373.32" font-family="Times,serif" font-size="14.00">r</text>
</g> <!-- ca&#45;&gt;car --> <g id="edge18" class="edge">
<title>
ca-&gt;car
</title>
<path fill="none"  d="M321.78,-431.7C320.83,-424.32 319.7,-415.52 318.63,-407.25"/>
<polygon   points="322.14,-407.08 317.39,-397.61 315.2,-407.97 322.14,-407.08"/>
</g> <!-- can --> <g id="node20" class="node">
<title>
can
</title>
<ellipse fill="none"  cx="387" cy="-378" rx="27" ry="18"/>
<text text-anchor="middle" x="387" y="-373.32" font-family="Times,serif" font-size="14.00">n</text>
</g> <!-- ca&#45;&gt;can --> <g id="edge19" class="edge">
<title>
ca-&gt;can
</title>
<path fill="none"  d="M337.36,-434.15C345.71,-424.87 356.65,-412.73 366.13,-402.19"/>
<polygon   points="368.56,-404.72 372.65,-394.95 363.35,-400.04 368.56,-404.72"/>
</g> <!-- cate --> <g id="node14" class="node">
<title>
cate
</title>
<ellipse fill="none"  cx="243" cy="-306" rx="27" ry="18"/>
<text text-anchor="middle" x="243" y="-301.32" font-family="Times,serif" font-size="14.00">e</text>
</g> <!-- cat&#45;&gt;cate --> <g id="edge13" class="edge">
<title>
cat-&gt;cate
</title>
<path fill="none"  d="M243,-359.7C243,-352.41 243,-343.73 243,-335.54"/>
<polygon   points="246.5,-335.62 243,-325.62 239.5,-335.62 246.5,-335.62"/>
</g> <!-- categ --> <g id="node15" class="node">
<title>
categ
</title>
<ellipse fill="none"  cx="243" cy="-234" rx="27" ry="18"/>
<text text-anchor="middle" x="243" y="-229.32" font-family="Times,serif" font-size="14.00">g</text>
</g> <!-- cate&#45;&gt;categ --> <g id="edge14" class="edge">
<title>
cate-&gt;categ
</title>
<path fill="none"  d="M243,-287.7C243,-280.41 243,-271.73 243,-263.54"/>
<polygon   points="246.5,-263.62 243,-253.62 239.5,-263.62 246.5,-263.62"/>
</g> <!-- catego --> <g id="node16" class="node">
<title>
catego
</title>
<ellipse fill="none"  cx="243" cy="-162" rx="27" ry="18"/>
<text text-anchor="middle" x="243" y="-157.32" font-family="Times,serif" font-size="14.00">o</text>
</g> <!-- categ&#45;&gt;catego --> <g id="edge15" class="edge">
<title>
categ-&gt;catego
</title>
<path fill="none"  d="M243,-215.7C243,-208.41 243,-199.73 243,-191.54"/>
<polygon   points="246.5,-191.62 243,-181.62 239.5,-191.62 246.5,-191.62"/>
</g> <!-- categor --> <g id="node17" class="node">
<title>
categor
</title>
<ellipse fill="none"  cx="243" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="243" y="-85.33" font-family="Times,serif" font-size="14.00">r</text>
</g> <!-- catego&#45;&gt;categor --> <g id="edge16" class="edge">
<title>
catego-&gt;categor
</title>
<path fill="none"  d="M243,-143.7C243,-136.41 243,-127.73 243,-119.54"/>
<polygon   points="246.5,-119.62 243,-109.62 239.5,-119.62 246.5,-119.62"/>
</g> <!-- category --> <g id="node18" class="node">
<title>
category
</title>
<ellipse fill="none"  cx="243" cy="-18" rx="27" ry="18"/>
<text text-anchor="middle" x="243" y="-13.32" font-family="Times,serif" font-size="14.00">y</text>
</g> <!-- categor&#45;&gt;category --> <g id="edge17" class="edge">
<title>
categor-&gt;category
</title>
<path fill="none"  d="M243,-71.7C243,-64.41 243,-55.73 243,-47.54"/>
<polygon   points="246.5,-47.62 243,-37.62 239.5,-47.62 246.5,-47.62"/>
</g> <!-- cand --> <g id="node21" class="node">
<title>
cand
</title>
<ellipse fill="none"  cx="387" cy="-306" rx="27" ry="18"/>
<text text-anchor="middle" x="387" y="-301.32" font-family="Times,serif" font-size="14.00">d</text>
</g> <!-- can&#45;&gt;cand --> <g id="edge20" class="edge">
<title>
can-&gt;cand
</title>
<path fill="none"  d="M387,-359.7C387,-352.41 387,-343.73 387,-335.54"/>
<polygon   points="390.5,-335.62 387,-325.62 383.5,-335.62 390.5,-335.62"/>
</g> <!-- candl --> <g id="node22" class="node">
<title>
candl
</title>
<ellipse fill="none"  cx="387" cy="-234" rx="27" ry="18"/>
<text text-anchor="middle" x="387" y="-229.32" font-family="Times,serif" font-size="14.00">l</text>
</g> <!-- cand&#45;&gt;candl --> <g id="edge21" class="edge">
<title>
cand-&gt;candl
</title>
<path fill="none"  d="M387,-287.7C387,-280.41 387,-271.73 387,-263.54"/>
<polygon   points="390.5,-263.62 387,-253.62 383.5,-263.62 390.5,-263.62"/>
</g> <!-- candle --> <g id="node23" class="node">
<title>
candle
</title>
<ellipse fill="none"  cx="387" cy="-162" rx="27" ry="18"/>
<text text-anchor="middle" x="387" y="-157.32" font-family="Times,serif" font-size="14.00">e</text>
</g> <!-- candl&#45;&gt;candle --> <g id="edge22" class="edge">
<title>
candl-&gt;candle
</title>
<path fill="none"  d="M387,-215.7C387,-208.41 387,-199.73 387,-191.54"/>
<polygon   points="390.5,-191.62 387,-181.62 383.5,-191.62 390.5,-191.62"/>
</g> <!-- cur --> <g id="node25" class="node">
<title>
cur
</title>
<ellipse fill="none"  cx="459" cy="-378" rx="27" ry="18"/>
<text text-anchor="middle" x="459" y="-373.32" font-family="Times,serif" font-size="14.00">r</text>
</g> <!-- cu&#45;&gt;cur --> <g id="edge24" class="edge">
<title>
cu-&gt;cur
</title>
<path fill="none"  d="M424.21,-433.12C429.68,-424.61 436.54,-413.94 442.72,-404.32"/>
<polygon   points="445.55,-406.4 448.01,-396.09 439.66,-402.61 445.55,-406.4"/>
</g> <!-- curr --> <g id="node26" class="node">
<title>
curr
</title>
<ellipse fill="none"  cx="459" cy="-306" rx="27" ry="18"/>
<text text-anchor="middle" x="459" y="-301.32" font-family="Times,serif" font-size="14.00">r</text>
</g> <!-- cur&#45;&gt;curr --> <g id="edge25" class="edge">
<title>
cur-&gt;curr
</title>
<path fill="none"  d="M459,-359.7C459,-352.41 459,-343.73 459,-335.54"/>
<polygon   points="462.5,-335.62 459,-325.62 455.5,-335.62 462.5,-335.62"/>
</g> <!-- curre --> <g id="node27" class="node">
<title>
curre
</title>
<ellipse fill="none"  cx="459" cy="-234" rx="27" ry="18"/>
<text text-anchor="middle" x="459" y="-229.32" font-family="Times,serif" font-size="14.00">e</text>
</g> <!-- curr&#45;&gt;curre --> <g id="edge26" class="edge">
<title>
curr-&gt;curre
</title>
<path fill="none"  d="M459,-287.7C459,-280.41 459,-271.73 459,-263.54"/>
<polygon   points="462.5,-263.62 459,-253.62 455.5,-263.62 462.5,-263.62"/>
</g> <!-- curren --> <g id="node28" class="node">
<title>
curren
</title>
<ellipse fill="none"  cx="459" cy="-162" rx="27" ry="18"/>
<text text-anchor="middle" x="459" y="-157.32" font-family="Times,serif" font-size="14.00">n</text>
</g> <!-- curre&#45;&gt;curren --> <g id="edge27" class="edge">
<title>
curre-&gt;curren
</title>
<path fill="none"  d="M459,-215.7C459,-208.41 459,-199.73 459,-191.54"/>
<polygon   points="462.5,-191.62 459,-181.62 455.5,-191.62 462.5,-191.62"/>
</g> <!-- current --> <g id="node29" class="node">
<title>
current
</title>
<ellipse fill="none"  cx="459" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="459" y="-85.33" font-family="Times,serif" font-size="14.00">t</text>
</g> <!-- curren&#45;&gt;current --> <g id="edge28" class="edge">
<title>
curren-&gt;current
</title>
<path fill="none"  d="M459,-143.7C459,-136.41 459,-127.73 459,-119.54"/>
<polygon   points="462.5,-119.62 459,-109.62 455.5,-119.62 462.5,-119.62"/>
</g> <!-- bat --> <g id="node31" class="node">
<title>
bat
</title>
<ellipse fill="none"  cx="531" cy="-378" rx="27" ry="18"/>
<text text-anchor="middle" x="531" y="-373.32" font-family="Times,serif" font-size="14.00">t</text>
</g> <!-- ba&#45;&gt;bat --> <g id="edge30" class="edge">
<title>
ba-&gt;bat
</title>
<path fill="none"  d="M524.22,-431.7C525.17,-424.32 526.3,-415.52 527.37,-407.25"/>
<polygon   points="530.8,-407.97 528.61,-397.61 523.86,-407.08 530.8,-407.97"/>
</g> </g>
</svg>
</div>
<p>Now, instead of being linear in the number of words times their
length, our search is only linear in the size of the prefix we are
looking for. In practice, where words tend to share prefixes, this turns
out to be <em>much</em> more efficient!</p>
<h2 id="back-to-the-world-of-types">Back to the world of types</h2>
<p>So, how can we use tries for type classes? Well, first of all, we
need a way to unroll our complicated nested types into a linear string
of atomic units that play a similar role to the characters in our word
trie.</p>
<p>For most types, this will be pretty straightforward. We can unroll
each of them into a linear string of <em>head constructors</em>. You can
view this transformation as a depth-first search on our type that
separates every type constructor from its arguments in every step. For
example, <code>Either(List(String), Array((Int, Bool)))</code> will be
unrolled into
<code>Either(_, _) -&gt; List(_) -&gt; String -&gt; Array(_) -&gt; (_, _) -&gt; Int -&gt; Bool</code>.</p>
<p>We can now already construct a trie to hold our instances from
above.</p>
<div class="dot-output">
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Generated by graphviz version 9.0.0 (0)
 -->
<!-- Pages: 1 -->
<svg width="341pt" height="260pt" viewBox="0.00 0.00 340.64 260.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 256)">
<!-- C --> <g id="node1" class="node">
<title>
C
</title>
<ellipse fill="none"  cx="124.32" cy="-234" rx="30.69" ry="18"/>
<text text-anchor="middle" x="124.32" y="-229.32" font-family="Times,serif" font-size="14.00">C(_)</text>
</g> <!-- Int --> <g id="node2" class="node">
<title>
Int
</title>
<ellipse fill="none"  cx="37.32" cy="-162" rx="27" ry="18"/>
<text text-anchor="middle" x="37.32" y="-157.32" font-family="Times,serif" font-size="14.00">Int</text>
</g> <!-- C&#45;&gt;Int --> <g id="edge1" class="edge">
<title>
C-&gt;Int
</title>
<path fill="none"  d="M106.71,-218.83C94.09,-208.68 76.89,-194.83 62.77,-183.47"/>
<polygon   points="65.18,-180.92 55.19,-177.38 60.79,-186.38 65.18,-180.92"/>
</g> <!-- List(_) --> <g id="node3" class="node">
<title>
List(_)
</title>
<ellipse fill="none"  cx="124.32" cy="-162" rx="42.26" ry="18"/>
<text text-anchor="middle" x="124.32" y="-157.32" font-family="Times,serif" font-size="14.00">List(_)</text>
</g> <!-- C&#45;&gt;List(_) --> <g id="edge2" class="edge">
<title>
C-&gt;List(_)
</title>
<path fill="none"  d="M124.32,-215.7C124.32,-208.41 124.32,-199.73 124.32,-191.54"/>
<polygon   points="127.82,-191.62 124.32,-181.62 120.82,-191.62 127.82,-191.62"/>
</g> <!-- (\\_, \\_) --> <g id="node6" class="node">
<title>
(\<em>, \</em>)
</title>
<ellipse fill="none"  cx="225.32" cy="-162" rx="40.69" ry="18"/>
<text text-anchor="middle" x="225.32" y="-157.32" font-family="Times,serif" font-size="14.00">(_,
_)</text> </g> <!-- C&#45;&gt;(\\_, \\_) --> <g id="edge5" class="edge">
<title>
C-&gt;(\<em>, \</em>)
</title>
<path fill="none"  d="M143.32,-219.83C157.74,-209.84 177.88,-195.88 194.59,-184.3"/>
<polygon   points="196.49,-187.24 202.72,-178.67 192.5,-181.49 196.49,-187.24"/>
</g> <!-- Bool --> <g id="node4" class="node">
<title>
Bool
</title>
<ellipse fill="none"  cx="33.32" cy="-90" rx="33.32" ry="18"/>
<text text-anchor="middle" x="33.32" y="-85.33" font-family="Times,serif" font-size="14.00">Bool</text>
</g> <!-- List(_)&#45;&gt;Bool --> <g id="edge3" class="edge">
<title>
List(_)-&gt;Bool
</title>
<path fill="none"  d="M104.57,-145.81C91.71,-135.92 74.75,-122.87 60.61,-111.99"/>
<polygon   points="63.05,-109.45 52.99,-106.13 58.78,-115 63.05,-109.45"/>
</g> <!-- String --> <g id="node5" class="node">
<title>
String
</title>
<ellipse fill="none"  cx="127.32" cy="-90" rx="42.79" ry="18"/>
<text text-anchor="middle" x="127.32" y="-85.33" font-family="Times,serif" font-size="14.00">String</text>
</g> <!-- List(_)&#45;&gt;String --> <g id="edge4" class="edge">
<title>
List(_)-&gt;String
</title>
<path fill="none"  d="M125.06,-143.7C125.37,-136.41 125.75,-127.73 126.1,-119.54"/>
<polygon   points="129.59,-119.76 126.52,-109.62 122.6,-119.46 129.59,-119.76"/>
</g> <!-- a --> <g id="node7" class="node">
<title>
a
</title>
<ellipse fill="none"  cx="221.32" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="221.32" y="-85.33" font-family="Times,serif" font-size="14.00">a</text>
</g> <!-- (\\_, \\_)&#45;&gt;a --> <g id="edge6" class="edge">
<title>
(\<em>, \</em>)-&gt;a
</title>
<path fill="none"  d="M224.33,-143.7C223.91,-136.41 223.42,-127.73 222.95,-119.54"/>
<polygon   points="226.45,-119.4 222.38,-109.62 219.46,-119.8 226.45,-119.4"/>
</g> <!-- Bool2 --> <g id="node9" class="node">
<title>
Bool2
</title>
<ellipse fill="none"  cx="299.32" cy="-90" rx="33.32" ry="18"/>
<text text-anchor="middle" x="299.32" y="-85.33" font-family="Times,serif" font-size="14.00">Bool</text>
</g> <!-- (\\_, \\_)&#45;&gt;Bool2 --> <g id="edge8" class="edge">
<title>
(\<em>, \</em>)-&gt;Bool2
</title>
<path fill="none"  d="M242.11,-145.12C251.94,-135.82 264.5,-123.93 275.36,-113.67"/>
<polygon   points="277.65,-116.32 282.51,-106.9 272.84,-111.23 277.65,-116.32"/>
</g> <!-- Int2 --> <g id="node8" class="node">
<title>
Int2
</title>
<ellipse fill="none"  cx="221.32" cy="-18" rx="27" ry="18"/>
<text text-anchor="middle" x="221.32" y="-13.32" font-family="Times,serif" font-size="14.00">Int</text>
</g> <!-- a&#45;&gt;Int2 --> <g id="edge7" class="edge">
<title>
a-&gt;Int2
</title>
<path fill="none"  d="M221.32,-71.7C221.32,-64.41 221.32,-55.73 221.32,-47.54"/>
<polygon   points="224.82,-47.62 221.32,-37.62 217.82,-47.62 224.82,-47.62"/>
</g> <!-- a2 --> <g id="node10" class="node">
<title>
a2
</title>
<ellipse fill="none"  cx="299.32" cy="-18" rx="27" ry="18"/>
<text text-anchor="middle" x="299.32" y="-13.32" font-family="Times,serif" font-size="14.00">a</text>
</g> <!-- Bool2&#45;&gt;a2 --> <g id="edge9" class="edge">
<title>
Bool2-&gt;a2
</title>
<path fill="none"  d="M299.32,-71.7C299.32,-64.41 299.32,-55.73 299.32,-47.54"/>
<polygon   points="302.82,-47.62 299.32,-37.62 295.82,-47.62 302.82,-47.62"/>
</g> </g>
</svg>
</div>
<p>You might even think that we could resolve instances by simply
searching through the trie just like we did in our text prediction
example above, but itâ€™s not quite that simple.</p>
<h2 id="universally-quantified-complications">Universally quantified
complications</h2>
<p>The issue is that some instances can contain universally quantified
type variables! In our case, we have two such instances:
<code>forall a. C(a, Int)</code> and
<code>forall a. C(Bool, a)</code>.</p>
<p>Trying to resolve, say <code>C(Bool, Int)</code>, needs to try both
instances and report an ambiguity error since both of them match.</p>
<p>More generally, at every inner node in our trie, there are either 0,
1, or 2 matching subtries that we need to check.</p>
<p>For example, looking up this instance in the trie above would
traverse all of the red nodes.</p>
<div class="dot-output">
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Generated by graphviz version 9.0.0 (0)
 -->
<!-- Pages: 1 -->
<svg width="341pt" height="260pt" viewBox="0.00 0.00 340.64 260.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 256)">
<!-- C --> <g id="node1" class="node">
<title>
C
</title>
<ellipse fill="none" stroke="red" cx="124.32" cy="-234" rx="30.69" ry="18"/>
<text text-anchor="middle" x="124.32" y="-229.32" font-family="Times,serif" font-size="14.00">C(_)</text>
</g> <!-- Int --> <g id="node2" class="node">
<title>
Int
</title>
<ellipse fill="none"  cx="37.32" cy="-162" rx="27" ry="18"/>
<text text-anchor="middle" x="37.32" y="-157.32" font-family="Times,serif" font-size="14.00">Int</text>
</g> <!-- C&#45;&gt;Int --> <g id="edge1" class="edge">
<title>
C-&gt;Int
</title>
<path fill="none"  d="M106.71,-218.83C94.09,-208.68 76.89,-194.83 62.77,-183.47"/>
<polygon   points="65.18,-180.92 55.19,-177.38 60.79,-186.38 65.18,-180.92"/>
</g> <!-- List(_) --> <g id="node3" class="node">
<title>
List(_)
</title>
<ellipse fill="none"  cx="124.32" cy="-162" rx="42.26" ry="18"/>
<text text-anchor="middle" x="124.32" y="-157.32" font-family="Times,serif" font-size="14.00">List(_)</text>
</g> <!-- C&#45;&gt;List(_) --> <g id="edge2" class="edge">
<title>
C-&gt;List(_)
</title>
<path fill="none"  d="M124.32,-215.7C124.32,-208.41 124.32,-199.73 124.32,-191.54"/>
<polygon   points="127.82,-191.62 124.32,-181.62 120.82,-191.62 127.82,-191.62"/>
</g> <!-- (\\_, \\_) --> <g id="node6" class="node">
<title>
(\<em>, \</em>)
</title>
<ellipse fill="none" stroke="red" cx="225.32" cy="-162" rx="40.69" ry="18"/>
<text text-anchor="middle" x="225.32" y="-157.32" font-family="Times,serif" font-size="14.00">(_,
_)</text> </g> <!-- C&#45;&gt;(\\_, \\_) --> <g id="edge5" class="edge">
<title>
C-&gt;(\<em>, \</em>)
</title>
<path fill="none" stroke="red" d="M143.32,-219.83C157.74,-209.84 177.88,-195.88 194.59,-184.3"/>
<polygon fill="red" stroke="red" points="196.49,-187.24 202.72,-178.67 192.5,-181.49 196.49,-187.24"/>
</g> <!-- Bool --> <g id="node4" class="node">
<title>
Bool
</title>
<ellipse fill="none"  cx="33.32" cy="-90" rx="33.32" ry="18"/>
<text text-anchor="middle" x="33.32" y="-85.33" font-family="Times,serif" font-size="14.00">Bool</text>
</g> <!-- List(_)&#45;&gt;Bool --> <g id="edge3" class="edge">
<title>
List(_)-&gt;Bool
</title>
<path fill="none"  d="M104.57,-145.81C91.71,-135.92 74.75,-122.87 60.61,-111.99"/>
<polygon   points="63.05,-109.45 52.99,-106.13 58.78,-115 63.05,-109.45"/>
</g> <!-- String --> <g id="node5" class="node">
<title>
String
</title>
<ellipse fill="none"  cx="127.32" cy="-90" rx="42.79" ry="18"/>
<text text-anchor="middle" x="127.32" y="-85.33" font-family="Times,serif" font-size="14.00">String</text>
</g> <!-- List(_)&#45;&gt;String --> <g id="edge4" class="edge">
<title>
List(_)-&gt;String
</title>
<path fill="none"  d="M125.06,-143.7C125.37,-136.41 125.75,-127.73 126.1,-119.54"/>
<polygon   points="129.59,-119.76 126.52,-109.62 122.6,-119.46 129.59,-119.76"/>
</g> <!-- a --> <g id="node7" class="node">
<title>
a
</title>
<ellipse fill="none" stroke="red" cx="221.32" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="221.32" y="-85.33" font-family="Times,serif" font-size="14.00">a</text>
</g> <!-- (\\_, \\_)&#45;&gt;a --> <g id="edge6" class="edge">
<title>
(\<em>, \</em>)-&gt;a
</title>
<path fill="none" stroke="red" d="M224.33,-143.7C223.91,-136.41 223.42,-127.73 222.95,-119.54"/>
<polygon fill="red" stroke="red" points="226.45,-119.4 222.38,-109.62 219.46,-119.8 226.45,-119.4"/>
</g> <!-- Bool2 --> <g id="node9" class="node">
<title>
Bool2
</title>
<ellipse fill="none" stroke="red" cx="299.32" cy="-90" rx="33.32" ry="18"/>
<text text-anchor="middle" x="299.32" y="-85.33" font-family="Times,serif" font-size="14.00">Bool</text>
</g> <!-- (\\_, \\_)&#45;&gt;Bool2 --> <g id="edge8" class="edge">
<title>
(\<em>, \</em>)-&gt;Bool2
</title>
<path fill="none" stroke="red" d="M242.11,-145.12C251.94,-135.82 264.5,-123.93 275.36,-113.67"/>
<polygon fill="red" stroke="red" points="277.65,-116.32 282.51,-106.9 272.84,-111.23 277.65,-116.32"/>
</g> <!-- Int2 --> <g id="node8" class="node">
<title>
Int2
</title>
<ellipse fill="none" stroke="red" cx="221.32" cy="-18" rx="27" ry="18"/>
<text text-anchor="middle" x="221.32" y="-13.32" font-family="Times,serif" font-size="14.00">Int</text>
</g> <!-- a&#45;&gt;Int2 --> <g id="edge7" class="edge">
<title>
a-&gt;Int2
</title>
<path fill="none" stroke="red" d="M221.32,-71.7C221.32,-64.41 221.32,-55.73 221.32,-47.54"/>
<polygon fill="red" stroke="red" points="224.82,-47.62 221.32,-37.62 217.82,-47.62 224.82,-47.62"/>
</g> <!-- a2 --> <g id="node10" class="node">
<title>
a2
</title>
<ellipse fill="none" stroke="red" cx="299.32" cy="-18" rx="27" ry="18"/>
<text text-anchor="middle" x="299.32" y="-13.32" font-family="Times,serif" font-size="14.00">a</text>
</g> <!-- Bool2&#45;&gt;a2 --> <g id="edge9" class="edge">
<title>
Bool2-&gt;a2
</title>
<path fill="none" stroke="red" d="M299.32,-71.7C299.32,-64.41 299.32,-55.73 299.32,-47.54"/>
<polygon fill="red" stroke="red" points="302.82,-47.62 299.32,-37.62 295.82,-47.62 302.82,-47.62"/>
</g> </g>
</svg>
</div>
<p>This might sound like it could lead to exponential blow-up, but it
actually doesnâ€™t! In the absolute worst case, instance lookup needs to
traverse every path through our trie, but that is exactly equivalent to
what our naive linear search strategy did so itâ€™s at least definitely
not slower than that.</p>
<p>Okay, so we traverse every possible path through our trie that
matches the types we are looking for. Is that it?</p>
<p>Not quite. Consider that variables might be used more than once in an
instance. For example, given an instance
<code>forall a. C((a, a))</code>, we need to check that the two
arguments to the tuple correspond to the same type.</p>
<p>To achieve this, we need to remember the first type we match a
variable against along a given path. If we come across this variable
again, we <em>patch</em> the trie by inserting the (unrolled) type where
the variable would be.</p>
<p>For example, say we have a trie with an instance for
<code>forall a. C((a, (a, Bool)))</code>. Now, matching this trie
against <code>C((List(Int), (List(Int), Bool)))</code> follows this
path. Once the traversal comes across the second occurrence of
<code>a</code>, it locally patches the trie by replacing <code>a</code>
with the blue path.</p>
<style>
.replaced {
    stroke: var(--gray);
    fill: var(--gray);
}
</style>
<div class="dot-output">
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Generated by graphviz version 9.0.0 (0)
 -->
<!-- Pages: 1 -->
<svg width="565pt" height="476pt" viewBox="0.00 0.00 564.84 476.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 472)">
<!-- C((List(Int), (List(Int), Bool))) --> <g id="node1" class="node">
<title>
C((List(Int), (List(Int), Bool)))
</title>
<ellipse fill="none" stroke="none" cx="156.43" cy="-450" rx="156.43" ry="18"/>
<text text-anchor="middle" x="156.43" y="-445.32" font-family="Times,serif" font-size="14.00" fill="red">C((List(Int),
(List(Int), Bool)))</text> </g> <!-- (List(Int), (List(Int), Bool)) -->
<g id="node2" class="node">
<title>
(List(Int), (List(Int), Bool))
</title>
<ellipse fill="none" stroke="none" cx="156.43" cy="-378" rx="141.7" ry="18"/>
<text text-anchor="middle" x="156.43" y="-373.32" font-family="Times,serif" font-size="14.00" fill="red">(List(Int),
(List(Int), Bool))</text> </g>
<!-- C((List(Int), (List(Int), Bool)))&#45;&gt;(List(Int), (List(Int), Bool)) -->
<g id="edge1" class="edge">
<title>
C((List(Int), (List(Int), Bool)))-&gt;(List(Int), (List(Int), Bool))
</title>
<path fill="none" stroke="none" d="M156.43,-431.7C156.43,-424.41 156.43,-415.73 156.43,-407.54"/>
<polygon fill="none" stroke="none" points="159.93,-407.62 156.43,-397.62 152.93,-407.62 159.93,-407.62"/>
</g> <!-- List(Int) | (List(Int), Bool) --> <g id="node3" class="node">
<title>
List(Int) | (List(Int), Bool)
</title>
<ellipse fill="none" stroke="none" cx="156.43" cy="-306" rx="137.49" ry="18"/>
<text text-anchor="middle" x="156.43" y="-301.32" font-family="Times,serif" font-size="14.00" fill="red">List(Int)
| (List(Int), Bool)</text> </g>
<!-- (List(Int), (List(Int), Bool))&#45;&gt;List(Int) | (List(Int), Bool) -->
<g id="edge2" class="edge">
<title>
(List(Int), (List(Int), Bool))-&gt;List(Int) | (List(Int), Bool)
</title>
<path fill="none" stroke="none" d="M156.43,-359.7C156.43,-352.41 156.43,-343.73 156.43,-335.54"/>
<polygon fill="none" stroke="none" points="159.93,-335.62 156.43,-325.62 152.93,-335.62 159.93,-335.62"/>
</g> <!-- (List(Int), Bool) --> <g id="node4" class="node">
<title>
(List(Int), Bool)
</title>
<ellipse fill="none" stroke="none" cx="156.43" cy="-234" rx="87.51" ry="18"/>
<text text-anchor="middle" x="156.43" y="-229.32" font-family="Times,serif" font-size="14.00" fill="red">(List(Int),
Bool)</text> </g>
<!-- List(Int) | (List(Int), Bool)&#45;&gt;(List(Int), Bool) -->
<g id="edge3" class="edge">
<title>
List(Int) | (List(Int), Bool)-&gt;(List(Int), Bool)
</title>
<path fill="none" stroke="none" d="M156.43,-287.7C156.43,-280.41 156.43,-271.73 156.43,-263.54"/>
<polygon fill="none" stroke="none" points="159.93,-263.62 156.43,-253.62 152.93,-263.62 159.93,-263.62"/>
</g> <!-- List(Int) | Bool --> <g id="node5" class="node">
<title>
List(Int) | Bool
</title>
<ellipse fill="none" stroke="none" cx="156.43" cy="-162" rx="83.3" ry="18"/>
<text text-anchor="middle" x="156.43" y="-157.32" font-family="Times,serif" font-size="14.00" fill="red">List(Int)
| Bool</text> </g> <!-- (List(Int), Bool)&#45;&gt;List(Int) | Bool -->
<g id="edge4" class="edge">
<title>
(List(Int), Bool)-&gt;List(Int) | Bool
</title>
<path fill="none" stroke="none" d="M156.43,-215.7C156.43,-208.41 156.43,-199.73 156.43,-191.54"/>
<polygon fill="none" stroke="none" points="159.93,-191.62 156.43,-181.62 152.93,-191.62 159.93,-191.62"/>
</g> <!-- Int | Bool --> <g id="node6" class="node">
<title>
Int | Bool
</title>
<ellipse fill="none" stroke="none" cx="156.43" cy="-90" rx="57" ry="18"/>
<text text-anchor="middle" x="156.43" y="-85.33" font-family="Times,serif" font-size="14.00" fill="red">Int
| Bool</text> </g> <!-- List(Int) | Bool&#45;&gt;Int | Bool -->
<g id="edge5" class="edge">
<title>
List(Int) | Bool-&gt;Int | Bool
</title>
<path fill="none" stroke="none" d="M156.43,-143.7C156.43,-136.41 156.43,-127.73 156.43,-119.54"/>
<polygon fill="none" stroke="none" points="159.93,-119.62 156.43,-109.62 152.93,-119.62 159.93,-119.62"/>
</g> <!-- Bool2 --> <g id="node7" class="node">
<title>
Bool2
</title>
<ellipse fill="none" stroke="none" cx="156.43" cy="-18" rx="33.32" ry="18"/>
<text text-anchor="middle" x="156.43" y="-13.32" font-family="Times,serif" font-size="14.00" fill="red">Bool</text>
</g> <!-- Int | Bool&#45;&gt;Bool2 --> <g id="edge6" class="edge">
<title>
Int | Bool-&gt;Bool2
</title>
<path fill="none" stroke="none" d="M156.43,-71.7C156.43,-64.41 156.43,-55.73 156.43,-47.54"/>
<polygon fill="none" stroke="none" points="159.93,-47.62 156.43,-37.62 152.93,-47.62 159.93,-47.62"/>
</g> <!-- C(_) --> <g id="node8" class="node">
<title>
C(_)
</title>
<ellipse fill="none"  cx="361.43" cy="-450" rx="30.69" ry="18"/>
<text text-anchor="middle" x="361.43" y="-445.32" font-family="Times,serif" font-size="14.00">C(_)</text>
</g> <!-- Pair --> <g id="node9" class="node">
<title>
Pair
</title>
<ellipse fill="none"  cx="361.43" cy="-378" rx="40.69" ry="18"/>
<text text-anchor="middle" x="361.43" y="-373.32" font-family="Times,serif" font-size="14.00">(_,
_)</text> </g> <!-- C(_)&#45;&gt;Pair --> <g id="edge7" class="edge">
<title>
C(_)-&gt;Pair
</title>
<path fill="none"  d="M361.43,-431.7C361.43,-424.41 361.43,-415.73 361.43,-407.54"/>
<polygon   points="364.93,-407.62 361.43,-397.62 357.93,-407.62 364.93,-407.62"/>
</g> <!-- a1 --> <g id="node10" class="node">
<title>
a1
</title>
<ellipse fill="none"  cx="361.43" cy="-306" rx="27" ry="18"/>
<text text-anchor="middle" x="361.43" y="-301.32" font-family="Times,serif" font-size="14.00">a</text>
</g> <!-- Pair&#45;&gt;a1 --> <g id="edge8" class="edge">
<title>
Pair-&gt;a1
</title>
<path fill="none"  d="M361.43,-359.7C361.43,-352.41 361.43,-343.73 361.43,-335.54"/>
<polygon   points="364.93,-335.62 361.43,-325.62 357.93,-335.62 364.93,-335.62"/>
</g> <!-- Pair2 --> <g id="node11" class="node">
<title>
Pair2
</title>
<ellipse fill="none"  cx="361.43" cy="-234" rx="40.69" ry="18"/>
<text text-anchor="middle" x="361.43" y="-229.32" font-family="Times,serif" font-size="14.00">(_,
_)</text> </g> <!-- a1&#45;&gt;Pair2 --> <g id="edge9" class="edge">
<title>
a1-&gt;Pair2
</title>
<path fill="none"  d="M361.43,-287.7C361.43,-280.41 361.43,-271.73 361.43,-263.54"/>
<polygon   points="364.93,-263.62 361.43,-253.62 357.93,-263.62 364.93,-263.62"/>
</g> <!-- a2 --> <g id="node12" class="node replaced">
<title>
a2
</title>
<ellipse fill="none"  cx="361.43" cy="-162" rx="27" ry="18"/>
<text text-anchor="middle" x="361.43" y="-157.32" font-family="Times,serif" font-size="14.00">a</text>
</g> <!-- Pair2&#45;&gt;a2 --> <g id="edge10" class="edge replaced">
<title>
Pair2-&gt;a2
</title>
<path fill="none"  d="M361.43,-215.7C361.43,-208.41 361.43,-199.73 361.43,-191.54"/>
<polygon   points="364.93,-191.62 361.43,-181.62 357.93,-191.62 364.93,-191.62"/>
</g> <!-- List --> <g id="node14" class="node">
<title>
List
</title>
<ellipse fill="none" stroke="blue" cx="436.43" cy="-162" rx="30.16" ry="18"/>
<text text-anchor="middle" x="436.43" y="-157.32" font-family="Times,serif" font-size="14.00">List</text>
</g> <!-- Pair2&#45;&gt;List --> <g id="edge12" class="edge">
<title>
Pair2-&gt;List
</title>
<path fill="none" stroke="blue" d="M378.07,-217.46C388.19,-208.03 401.26,-195.82 412.47,-185.36"/>
<polygon fill="blue" stroke="blue" points="414.57,-188.19 419.5,-178.81 409.8,-183.07 414.57,-188.19"/>
</g> <!-- Bool --> <g id="node13" class="node">
<title>
Bool
</title>
<ellipse fill="none"  cx="361.43" cy="-18" rx="33.32" ry="18"/>
<text text-anchor="middle" x="361.43" y="-13.32" font-family="Times,serif" font-size="14.00">Bool</text>
</g> <!-- a2&#45;&gt;Bool --> <g id="edge11" class="edge replaced">
<title>
a2-&gt;Bool
</title>
<path fill="none"  d="M361.43,-143.59C361.43,-119.61 361.43,-76.14 361.43,-47.42"/>
<polygon   points="364.93,-47.62 361.43,-37.62 357.93,-47.62 364.93,-47.62"/>
</g> <!-- Int --> <g id="node15" class="node">
<title>
Int
</title>
<ellipse fill="none" stroke="blue" cx="436.43" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="436.43" y="-85.33" font-family="Times,serif" font-size="14.00">Int</text>
</g> <!-- List&#45;&gt;Int --> <g id="edge13" class="edge">
<title>
List-&gt;Int
</title>
<path fill="none" stroke="blue" d="M436.43,-143.7C436.43,-136.41 436.43,-127.73 436.43,-119.54"/>
<polygon fill="blue" stroke="blue" points="439.93,-119.62 436.43,-109.62 432.93,-119.62 439.93,-119.62"/>
</g> <!-- Int&#45;&gt;Bool --> <g id="edge14" class="edge">
<title>
Int-&gt;Bool
</title>
<path fill="none" stroke="blue" d="M421.25,-74.83C411.06,-65.32 397.4,-52.57 385.71,-41.66"/>
<polygon fill="blue" stroke="blue" points="388.43,-39.41 378.73,-35.15 383.65,-44.53 388.43,-39.41"/>
</g> <!-- subst --> <g id="node16" class="node">
<title>
subst
</title>
<ellipse fill="none" stroke="none" cx="481.43" cy="-306" rx="75.41" ry="18"/>
<text text-anchor="middle" x="481.43" y="-301.32" font-family="Times,serif" font-size="14.00" fill="red">a
:= List(Int)</text> </g> </g>
</svg>
</div>
<p>And thatâ€™s it! This is enough to fully implement type class
resolution in languages like Haskell, Rust or PureScript.</p>
<h2 id="what-about-entailment">What about entailment?</h2>
<p>This can easily match simple instances, but what about instances like
<code>forall a. C(a) =&gt; C(List(a))</code>? Here,
<code>C(List(a))</code> <em>entails</em> <code>C(a)</code>, such that
<code>C(List(a))</code> only holds if <code>C(a)</code> holds. How do we
take that into account?</p>
<p>Well, following GHCâ€™s footsteps, this is very easy: we donâ€™t! Type
class resolution only matches the â€œinstance headâ€ (i.e.Â the part after
the <code>=&gt;</code>), so we only need to emit a <em>new</em>
constraint for <code>C(a)</code> when we land on that instance (using
our substitution to find the correct type for <code>a</code>).</p>
<p>This might seem a bit limiting and there are more elaborate systems
that can use entailment information, but in an open world setting like
type classes where any module might add new instances, these can have
some serious subtle downsides around modularity. Only matching on the
instance head is a very reasonable pragmatic choice that is enough to
cover most real world cases while keeping excellent performance.</p>
<h2 id="row-polymorphism">Row Polymorphism</h2>
<p>The system we covered so far works very well for classic ML-style
type systems that consist exclusively of (possibly parameterized) type
constructors, but not every type system is this simple.</p>
<p>A common type system extension is row polymorphism, which can be used
to model extensible records, polymorphic variants, and even algebraic
effects. How do we include this in our trie?</p>
<p>The fundamental issue with row polymorphism is that the order of
labels in a row does not matter. In other words,
<code>{ x : Int, y : Bool }</code> and
<code>{ y : Bool, x : Int }</code> are the same type (and hence,
depending on the instantiations of <code>a</code> and <code>b</code>,
even <code>{ x : Int | a }</code> and <code>{ y : Bool | b }</code>
might be equal). Depending on the exact flavor of your type system, rows
might be allowed to have duplicate labels. In that case, only the order
of <em>distinct</em> labels is irrelevant. For example,
<code>{ x : Int, y : Bool, x : String }</code> is equal to
<code>{ y : Bool, x : Int, x : String }</code>, but not
<code>{ x : String, x : Int, y : Bool }</code>.</p>
<p>How could we possibly represent type class instances for these types
in a trie?</p>
<p>The answer is actually surprisingly easy. We can treat the record
with only its labels as a head constructor, similar to what we did
before. Unlike before, we <em>canonicalize</em> rows by sorting their
fields. This is especially important if we want to use the trie to
detect two instances for exactly the same type (since we should probably
throw an error in that case).</p>
<p>A beautiful property of the duplicate label semantics outlined above
is that canonicalizing records with duplicate labels boils down to a
stable sort since it only needs to preserve the order of duplicate
labels.</p>
<p>For example, <code>{ y : Bool, x : Int }</code> will be canonicalized
to <code>{ x : Int, y : Bool }</code> and subsequently unrolled to</p>
<div class="dot-output">
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Generated by graphviz version 9.0.0 (0)
 -->
<!-- Pages: 1 -->
<svg width="174pt" height="188pt" viewBox="0.00 0.00 173.55 188.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 184)">
<!-- { x : \\_, y : \\_ } --> <g id="node1" class="node">
<title>
{ x : \<em>, y : \</em> }
</title>
<ellipse fill="none"  cx="82.77" cy="-162" rx="82.77" ry="18"/>
<text text-anchor="middle" x="82.77" y="-157.32" font-family="Times,serif" font-size="14.00">{
x : _, y : _ }</text> </g> <!-- Int --> <g id="node2" class="node">
<title>
Int
</title>
<ellipse fill="none"  cx="82.77" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="82.77" y="-85.33" font-family="Times,serif" font-size="14.00">Int</text>
</g> <!-- { x : \\_, y : \\_ }&#45;&gt;Int -->
<g id="edge1" class="edge">
<title>
{ x : \<em>, y : \</em> }-&gt;Int
</title>
<path fill="none"  d="M82.77,-143.7C82.77,-136.41 82.77,-127.73 82.77,-119.54"/>
<polygon   points="86.27,-119.62 82.77,-109.62 79.27,-119.62 86.27,-119.62"/>
</g> <!-- Bool --> <g id="node3" class="node">
<title>
Bool
</title>
<ellipse fill="none"  cx="82.77" cy="-18" rx="33.32" ry="18"/>
<text text-anchor="middle" x="82.77" y="-13.32" font-family="Times,serif" font-size="14.00">Bool</text>
</g> <!-- Int&#45;&gt;Bool --> <g id="edge2" class="edge">
<title>
Int-&gt;Bool
</title>
<path fill="none"  d="M82.77,-71.7C82.77,-64.41 82.77,-55.73 82.77,-47.54"/>
<polygon   points="86.27,-47.62 82.77,-37.62 79.27,-47.62 86.27,-47.62"/>
</g> </g>
</svg>
</div>
<p>and <code>{ x : Int, y : Bool, x : String | a }</code> becomes</p>
<div class="dot-output">
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Generated by graphviz version 9.0.0 (0)
 -->
<!-- Pages: 1 -->
<svg width="267pt" height="332pt" viewBox="0.00 0.00 267.20 332.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 328)">
<!-- { x : \\_, x : \\_, y : \\_ | \\_ } --> <g id="node1" class="node">
<title>
{ x : \<em>, x : \</em>, y : \_ | \_ }
</title>
<ellipse fill="none"  cx="129.6" cy="-306" rx="129.6" ry="18"/>
<text text-anchor="middle" x="129.6" y="-301.32" font-family="Times,serif" font-size="14.00">{
x : _, x : _, y : _ | _ }</text> </g> <!-- Int -->
<g id="node2" class="node">
<title>
Int
</title>
<ellipse fill="none"  cx="129.6" cy="-234" rx="27" ry="18"/>
<text text-anchor="middle" x="129.6" y="-229.32" font-family="Times,serif" font-size="14.00">Int</text>
</g> <!-- { x : \\_, x : \\_, y : \\_ | \\_ }&#45;&gt;Int -->
<g id="edge1" class="edge">
<title>
{ x : \<em>, x : \</em>, y : \_ | \_ }-&gt;Int
</title>
<path fill="none"  d="M129.6,-287.7C129.6,-280.41 129.6,-271.73 129.6,-263.54"/>
<polygon   points="133.1,-263.62 129.6,-253.62 126.1,-263.62 133.1,-263.62"/>
</g> <!-- String --> <g id="node3" class="node">
<title>
String
</title>
<ellipse fill="none"  cx="129.6" cy="-162" rx="42.79" ry="18"/>
<text text-anchor="middle" x="129.6" y="-157.32" font-family="Times,serif" font-size="14.00">String</text>
</g> <!-- Int&#45;&gt;String --> <g id="edge2" class="edge">
<title>
Int-&gt;String
</title>
<path fill="none"  d="M129.6,-215.7C129.6,-208.41 129.6,-199.73 129.6,-191.54"/>
<polygon   points="133.1,-191.62 129.6,-181.62 126.1,-191.62 133.1,-191.62"/>
</g> <!-- Bool --> <g id="node4" class="node">
<title>
Bool
</title>
<ellipse fill="none"  cx="129.6" cy="-90" rx="33.32" ry="18"/>
<text text-anchor="middle" x="129.6" y="-85.33" font-family="Times,serif" font-size="14.00">Bool</text>
</g> <!-- String&#45;&gt;Bool --> <g id="edge3" class="edge">
<title>
String-&gt;Bool
</title>
<path fill="none"  d="M129.6,-143.7C129.6,-136.41 129.6,-127.73 129.6,-119.54"/>
<polygon   points="133.1,-119.62 129.6,-109.62 126.1,-119.62 133.1,-119.62"/>
</g> <!-- a --> <g id="node5" class="node">
<title>
a
</title>
<ellipse fill="none"  cx="129.6" cy="-18" rx="27" ry="18"/>
<text text-anchor="middle" x="129.6" y="-13.32" font-family="Times,serif" font-size="14.00">a</text>
</g> <!-- Bool&#45;&gt;a --> <g id="edge4" class="edge">
<title>
Bool-&gt;a
</title>
<path fill="none"  d="M129.6,-71.7C129.6,-64.41 129.6,-55.73 129.6,-47.54"/>
<polygon   points="133.1,-47.62 129.6,-37.62 126.1,-47.62 133.1,-47.62"/>
</g> </g>
</svg>
</div>
<p>Now, when matching a type against a row head constructor like this,
we move the types from the head constructor labels to the front in
canonical order. This ensures that they are matched against the correct
trie fields and keeps the remaining row to be matched against the
extension variable if applicable.</p>
<p>For example, this is how one possible match could behave</p>
<div class="dot-output">
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Generated by graphviz version 9.0.0 (0)
 -->
<!-- Pages: 1 -->
<svg width="596pt" height="260pt" viewBox="0.00 0.00 596.42 260.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 256)">
<!-- record --> <g id="node1" class="node">
<title>
record
</title>
<text text-anchor="middle" x="132.23" y="-229.32" font-family="Times,serif" font-size="14.00" fill="red">{
z : String, y : Bool, x : Int }</text> </g>
<!-- Int | String | { y : Bool } --> <g id="node2" class="node">
<title>
Int | String | { y : Bool }
</title>
<ellipse fill="none" stroke="none" cx="132.23" cy="-162" rx="132.23" ry="18"/>
<text text-anchor="middle" x="132.23" y="-157.32" font-family="Times,serif" font-size="14.00" fill="red">Int
| String | { y : Bool }</text> </g>
<!-- record&#45;&gt;Int | String | { y : Bool } -->
<g id="edge1" class="edge">
<title>
record-&gt;Int | String | { y : Bool }
</title>
<path fill="none" stroke="none" d="M132.23,-216.05C132.23,-208.68 132.23,-199.84 132.23,-191.51"/>
<polygon fill="none" stroke="none" points="135.73,-191.79 132.23,-181.79 128.73,-191.79 135.73,-191.79"/>
</g> <!-- String | { y : Bool } --> <g id="node3" class="node">
<title>
String | { y : Bool }
</title>
<ellipse fill="none" stroke="none" cx="132.23" cy="-90" rx="108.55" ry="18"/>
<text text-anchor="middle" x="132.23" y="-85.33" font-family="Times,serif" font-size="14.00" fill="red">String
| { y : Bool }</text> </g>
<!-- Int | String | { y : Bool }&#45;&gt;String | { y : Bool } -->
<g id="edge2" class="edge">
<title>
Int | String | { y : Bool }-&gt;String | { y : Bool }
</title>
<path fill="none" stroke="none" d="M132.23,-143.7C132.23,-136.41 132.23,-127.73 132.23,-119.54"/>
<polygon fill="none" stroke="none" points="135.73,-119.62 132.23,-109.62 128.73,-119.62 135.73,-119.62"/>
</g> <!-- { y : Bool } --> <g id="node4" class="node">
<title>
{ y : Bool }
</title>
<ellipse fill="none" stroke="none" cx="132.23" cy="-18" rx="67.52" ry="18"/>
<text text-anchor="middle" x="132.23" y="-13.32" font-family="Times,serif" font-size="14.00" fill="red">{
y : Bool }</text> </g>
<!-- String | { y : Bool }&#45;&gt;{ y : Bool } -->
<g id="edge3" class="edge">
<title>
String | { y : Bool }-&gt;{ y : Bool }
</title>
<path fill="none" stroke="none" d="M132.23,-71.7C132.23,-64.41 132.23,-55.73 132.23,-47.54"/>
<polygon fill="none" stroke="none" points="135.73,-47.62 132.23,-37.62 128.73,-47.62 135.73,-47.62"/>
</g> <!-- rowhead --> <g id="node5" class="node">
<title>
rowhead
</title>
<ellipse fill="none"  cx="361.23" cy="-234" rx="99.61" ry="18"/>
<text text-anchor="middle" x="361.23" y="-229.32" font-family="Times,serif" font-size="14.00">{
x : _, z : _ | _ }</text> </g> <!-- Int --> <g id="node6" class="node">
<title>
Int
</title>
<ellipse fill="none"  cx="361.23" cy="-162" rx="27" ry="18"/>
<text text-anchor="middle" x="361.23" y="-157.32" font-family="Times,serif" font-size="14.00">Int</text>
</g> <!-- rowhead&#45;&gt;Int --> <g id="edge4" class="edge">
<title>
rowhead-&gt;Int
</title>
<path fill="none"  d="M361.23,-215.7C361.23,-208.41 361.23,-199.73 361.23,-191.54"/>
<polygon   points="364.73,-191.62 361.23,-181.62 357.73,-191.62 364.73,-191.62"/>
</g> <!-- String --> <g id="node7" class="node">
<title>
String
</title>
<ellipse fill="none"  cx="361.23" cy="-90" rx="42.79" ry="18"/>
<text text-anchor="middle" x="361.23" y="-85.33" font-family="Times,serif" font-size="14.00">String</text>
</g> <!-- Int&#45;&gt;String --> <g id="edge5" class="edge">
<title>
Int-&gt;String
</title>
<path fill="none"  d="M361.23,-143.7C361.23,-136.41 361.23,-127.73 361.23,-119.54"/>
<polygon   points="364.73,-119.62 361.23,-109.62 357.73,-119.62 364.73,-119.62"/>
</g> <!-- a --> <g id="node8" class="node">
<title>
a
</title>
<ellipse fill="none"  cx="361.23" cy="-18" rx="27" ry="18"/>
<text text-anchor="middle" x="361.23" y="-13.32" font-family="Times,serif" font-size="14.00">a</text>
</g> <!-- String&#45;&gt;a --> <g id="edge6" class="edge">
<title>
String-&gt;a
</title>
<path fill="none"  d="M361.23,-71.7C361.23,-64.41 361.23,-55.73 361.23,-47.54"/>
<polygon   points="364.73,-47.62 361.23,-37.62 357.73,-47.62 364.73,-47.62"/>
</g> <!-- a := { y : Bool } --> <g id="node9" class="node">
<title>
a := { y : Bool }
</title>
<ellipse fill="none" stroke="none" cx="497.23" cy="-18" rx="91.19" ry="18"/>
<text text-anchor="middle" x="497.23" y="-13.32" font-family="Times,serif" font-size="14.00" fill="red">a
:= { y : Bool }</text> </g> </g>
</svg>
</div>
<h2 id="overlapping-instances">Overlapping instances</h2>
<p>Usually, requiring type class resolution to come up with a single
unambiguous instance is the right choice, but sometimes it makes sense
to disambiguate explicitly and let the compiler choose one instance over
another. Can we do this with our trie?</p>
<p>Yes! In fact, since we report every matching candidate, we can
perform this disambiguation entirely on the result of type class
resolution without ever touching our trie. The exact rules for how to do
this can be a bit subtle, but one reasonable approach is the one taken
by GHC, which is documented <a
href="https://ghc.gitlab.haskell.org/ghc/doc/users_guide/exts/instances.html#overlapping-instances">in
the fantastic GHC Userâ€™s Guide</a><a href="#fn3" class="footnote-ref"
id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Even if you donâ€™t plan on implementing a programming language with
type classes any time soon (why not?), there are a few things I would
like you to take away from this.</p>
<ul>
<li>Tries are awesome!</li>
<li>Picking the right data structures is incredibly important, even in
domains like type checkers where they typically donâ€™t receive that much
love.</li>
<li>There is a lot to be gained by applying knowledge from one area of
computer science (e.g.Â text processing) to another (e.g.Â type
checking)</li>
</ul>
<p>If nothing else, this gave me a great opportunity to try out GraphViz
support on my blog.</p>
<aside id="footnotes" class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>To my knowledge at the time of writing anyway. They
might have moved to something more efficient by now.<a href="#fnref1"
class="footnote-back" role="doc-backlink">â†©ï¸Ž</a></p></li>
<li id="fn2"><p>sorry.<a href="#fnref2" class="footnote-back"
role="doc-backlink">â†©ï¸Ž</a></p></li>
<li id="fn3"><p>Seriously, this is an incredibly underrated resource for
nearly everything related to Haskell and GHC.<a href="#fnref3"
class="footnote-back" role="doc-backlink">â†©ï¸Ž</a></p></li>
</ol>
</aside>
        <hr>
        If you want to tell me your thoughts about this post, you can leave a comment on <a href="https://www.reddit.com/r/ProgrammingLanguages/comments/1auxy31/blazingly_fast_type_class_resolution_with_tries/">Reddit</a>
        or <a href="/about.html">contact me directly</a>.
        <script src="/js/main.js"></script>
    </article>
</body>

</html>