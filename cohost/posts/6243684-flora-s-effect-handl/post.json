{"postId":6243684,"headline":"Flora's effect handlers","publishedAt":"2024-06-03T09:25:45.901Z","state":1,"cws":[],"tags":["flora","programming languages","PLT","Effects","(whoah the first tag that comes up for \"effect\" is #mass effect i love cohost)","cps","continuation passing style"],"blocks":[{"type":"ask","ask":{"askId":"1116332051524486968","anon":false,"loggedIn":true,"askingProject":{"projectId":32173,"avatarPreviewURL":"https://staging.cohostcdn.org/avatar/32173-8b30036a-55a1-4584-8937-04716e22532d-profile.png","avatarShape":"roundrect","avatarURL":"https://staging.cohostcdn.org/avatar/32173-8b30036a-55a1-4584-8937-04716e22532d-profile.png","flags":[],"handle":"Quelklef","privacy":"public","displayName":"Maynard"},"content":"how are floras effects implemented?\n\nspecifically i'm wondering if code being \"effectful\" means that it *emits* effects (ala haskell) or that it *consumes* effect handlers (ala effekt)","sentAt":"2024-06-03T05:52:30.765Z"}},{"type":"markdown","markdown":{"content":"It's actually really simple! They use CPS."}},{"type":"markdown","markdown":{"content":"If you had a pure language without effects, your top-level eval function might have a type that looks something like this"}},{"type":"markdown","markdown":{"content":"<pre tabindex=\"0\" style=\"box-sizing: border-box; padding: 0.5rem; margin: 1.25rem 0px 0px; border-radius: 0.25rem 0.25rem 0px 0px; line-height: 1.5; overflow-x: auto; color-scheme: dark; background: rgb(40, 42, 54); color: rgb(248, 248, 242); scrollbar-color: rgb(248, 248, 242) rgb(25, 26, 33);\"><code><span>eval</span> <span style=\"color: rgb(255, 121, 198);\">::</span> <span style=\"color: rgb(189, 147, 249);\">String</span>  <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">Value</span></code></pre><div style=\"margin-bottom: 1.25rem; padding: 0.25rem 0.5rem; font-size: smaller; text-align: right; border-radius: 0px 0px 0.25rem 0.25rem; background: rgb(25, 26, 33); color: rgb(248, 248, 242);\">syntax highlighting by <a href=\"https://codehost.wavebeem.com\">codehost</a></div>"}},{"type":"markdown","markdown":{"content":"but in Flora, this type is (roughly equivalent to)"}},{"type":"markdown","markdown":{"content":"<pre tabindex=\"0\" style=\"box-sizing: border-box; padding: 0.5rem; margin: 1.25rem 0px; border-radius: 0.25rem; line-height: 1.5; overflow-x: auto; color-scheme: dark; background: rgb(40, 42, 54); color: rgb(248, 248, 242); scrollbar-color: rgb(248, 248, 242) rgb(25, 26, 33);\"><code><span>eval</span> <span style=\"color: rgb(255, 121, 198);\">::</span> <span style=\"color: rgb(189, 147, 249);\">String</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">EvalResult</span>"}},{"type":"markdown","markdown":{"content":"<span style=\"color: rgb(255, 121, 198);\">data</span> <span style=\"color: rgb(189, 147, 249);\">EvalResult</span>\n  <span style=\"color: rgb(255, 121, 198);\">=</span> <span style=\"color: rgb(189, 147, 249);\">Completed</span> <span style=\"color: rgb(189, 147, 249);\">Value</span>\n  <span style=\"color: rgb(255, 121, 198);\">|</span> <span style=\"color: rgb(189, 147, 249);\">Effect</span> <span style=\"color: rgb(189, 147, 249);\">String</span> <span style=\"color: rgb(248, 248, 242);\">[</span><span style=\"color: rgb(189, 147, 249);\">Value</span><span style=\"color: rgb(248, 248, 242);\">]</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span style=\"color: rgb(189, 147, 249);\">Value</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">EvalResult</span><span style=\"color: rgb(248, 248, 242);\">)</span>\n</code></pre>"}},{"type":"markdown","markdown":{"content":"So from an API standpoint, what is happening is that evaluating an expression either returns or performs an effect (which returns the name of the effect, its arguments and a continuation) and so the host language can handle the effect by just matching on this `EvalResult`."}},{"type":"markdown","markdown":{"content":"Actually, the *full* type is closer to"}},{"type":"markdown","markdown":{"content":"<pre tabindex=\"0\" style=\"box-sizing: border-box; padding: 0.5rem; margin: 1.25rem 0px; border-radius: 0.25rem; line-height: 1.5; overflow-x: auto; color-scheme: dark; background: rgb(40, 42, 54); color: rgb(248, 248, 242); scrollbar-color: rgb(248, 248, 242) rgb(25, 26, 33);\"><code><span>eval</span> <span style=\"color: rgb(255, 121, 198);\">::</span> <span style=\"color: rgb(189, 147, 249);\">String</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">Fuel</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">EvalResult</span>"}},{"type":"markdown","markdown":{"content":"<span style=\"color: rgb(255, 121, 198);\">data</span> <span style=\"color: rgb(189, 147, 249);\">EvalResult</span>\n  <span style=\"color: rgb(255, 121, 198);\">=</span> <span style=\"color: rgb(189, 147, 249);\">Completed</span> <span style=\"color: rgb(189, 147, 249);\">Value</span>\n  <span style=\"color: rgb(255, 121, 198);\">|</span> <span style=\"color: rgb(189, 147, 249);\">Effect</span> <span style=\"color: rgb(189, 147, 249);\">String</span> <span style=\"color: rgb(248, 248, 242);\">[</span><span style=\"color: rgb(189, 147, 249);\">Value</span><span style=\"color: rgb(248, 248, 242);\">]</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span style=\"color: rgb(189, 147, 249);\">Value</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">EvalResult</span><span style=\"color: rgb(248, 248, 242);\">)</span>\n  <span style=\"color: rgb(255, 121, 198);\">|</span> <span style=\"color: rgb(189, 147, 249);\">Suspended</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span style=\"color: rgb(248, 248, 242);\">(</span><span style=\"color: rgb(248, 248, 242);\">)</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">EvalResult</span><span style=\"color: rgb(248, 248, 242);\">)</span></code></pre>"}},{"type":"markdown","markdown":{"content":"because there is also fuel system that can preempt long running computations, which slots in extremely nicely with effect handlers and works in practically the same way!"}},{"type":"markdown","markdown":{"content":"## So what does that look like under the hood?"}},{"type":"markdown","markdown":{"content":"Internally, evaluation is entirely in CPS, so *usually* functions will never return but will only pass on or tail call into a continuation, which looks like this"}},{"type":"markdown","markdown":{"content":"<pre tabindex=\"0\" style=\"box-sizing: border-box; padding: 0.5rem; margin: 1.25rem 0px; border-radius: 0.25rem; line-height: 1.5; overflow-x: auto; color-scheme: dark; background: rgb(40, 42, 54); color: rgb(248, 248, 242); scrollbar-color: rgb(248, 248, 242) rgb(25, 26, 33);\"><code><span>eval</span> <span style=\"color: rgb(255, 121, 198);\">::</span> <span style=\"color: rgb(189, 147, 249);\">Env</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">Expr</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span style=\"color: rgb(189, 147, 249);\">Value</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">EvalResult</span><span style=\"color: rgb(248, 248, 242);\">)</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">EvalResult</span>\n<span>eval</span> <span>env</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span style=\"color: rgb(189, 147, 249);\">Var</span> <span>x</span><span style=\"color: rgb(248, 248, 242);\">)</span> <span>cont</span> <span style=\"color: rgb(255, 121, 198);\">=</span> <span>cont</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span>findVariable</span> <span>x</span> <span>env</span><span style=\"color: rgb(248, 248, 242);\">)</span>\n<span>eval</span> <span>env</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span style=\"color: rgb(189, 147, 249);\">App</span> <span>funExpr</span> <span>argExpr</span><span style=\"color: rgb(248, 248, 242);\">)</span> <span style=\"color: rgb(255, 121, 198);\">=</span>\n    <span>eval</span> <span>env</span> <span>funExpr</span> <span style=\"color: rgb(255, 121, 198);\">\\</span><span>funValue</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span>\n        <span>eval</span> <span>env</span> <span>argExpr</span> <span style=\"color: rgb(255, 121, 198);\">\\</span><span>argValue</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span>\n            <span style=\"color: rgb(255, 121, 198);\">case</span> <span>funValue</span> <span style=\"color: rgb(255, 121, 198);\">of</span>\n                <span style=\"color: rgb(189, 147, 249);\">Closure</span> <span>closureEnv</span> <span>param</span> <span>body</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span>\n                    <span>eval</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span>define</span> <span>param</span> <span>argValue</span> <span>closureEnv</span><span style=\"color: rgb(248, 248, 242);\">)</span> <span>body</span></code></pre>"}},{"type":"markdown","markdown":{"content":"Where whatever runs this at the top level wraps the result in a `Completed`"}},{"type":"markdown","markdown":{"content":"<pre tabindex=\"0\" style=\"box-sizing: border-box; padding: 0.5rem; margin: 1.25rem 0px; border-radius: 0.25rem; line-height: 1.5; overflow-x: auto; color-scheme: dark; background: rgb(40, 42, 54); color: rgb(248, 248, 242); scrollbar-color: rgb(248, 248, 242) rgb(25, 26, 33);\"><code><span>evalFinal</span> <span style=\"color: rgb(255, 121, 198);\">::</span> <span style=\"color: rgb(189, 147, 249);\">Env</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">Expr</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">EvalResult</span>\n<span>evalFinal</span> <span>env</span> <span>expr</span> <span style=\"color: rgb(255, 121, 198);\">=</span> <span>eval</span> <span>env</span> <span>expr</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span style=\"color: rgb(255, 121, 198);\">\\</span><span>result</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">Completed</span> <span>result</span><span style=\"color: rgb(248, 248, 242);\">)</span></code></pre>"}},{"type":"markdown","markdown":{"content":"But, if the called code performs an effect, eval just returns immediately and passes the continuation on to the caller"}},{"type":"markdown","markdown":{"content":"<pre tabindex=\"0\" style=\"box-sizing: border-box; padding: 0.5rem; margin: 1.25rem 0px; border-radius: 0.25rem; line-height: 1.5; overflow-x: auto; color-scheme: dark; background: rgb(40, 42, 54); color: rgb(248, 248, 242); scrollbar-color: rgb(248, 248, 242) rgb(25, 26, 33);\"><code><span>eval</span> <span>env</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span style=\"color: rgb(189, 147, 249);\">Perform</span> <span>effectName</span> <span>argumentExprs</span><span style=\"color: rgb(248, 248, 242);\">)</span> <span>cont</span> <span style=\"color: rgb(255, 121, 198);\">=</span>\n    <span>evalAll</span> <span>argumentExprs</span> <span style=\"color: rgb(255, 121, 198);\">\\</span><span>arguments</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span>\n        <span style=\"color: rgb(189, 147, 249);\">Effect</span> <span>effectName</span> <span>arguments</span> <span>cont</span></code></pre>"}},{"type":"markdown","markdown":{"content":"On its own, this will immediately return the effect to the host-language, but if we have a handler we need to intercept the `Effect` result first and run our handler on it."}},{"type":"markdown","markdown":{"content":"<pre tabindex=\"0\" style=\"box-sizing: border-box; padding: 0.5rem; margin: 1.25rem 0px; border-radius: 0.25rem; line-height: 1.5; overflow-x: auto; color-scheme: dark; background: rgb(40, 42, 54); color: rgb(248, 248, 242); scrollbar-color: rgb(248, 248, 242) rgb(25, 26, 33);\"><code><span>eval</span> <span>env</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span style=\"color: rgb(189, 147, 249);\">Handle</span> <span>handler</span> <span>expr</span><span style=\"color: rgb(248, 248, 242);\">)</span> <span>cont</span> <span style=\"color: rgb(255, 121, 198);\">=</span>\n    <span style=\"color: rgb(255, 121, 198);\">case</span> <span>eval</span> <span>env</span> <span>expr</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span style=\"color: rgb(255, 121, 198);\">\\</span><span>x</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">Completed</span> <span>x</span><span style=\"color: rgb(248, 248, 242);\">)</span> <span style=\"color: rgb(255, 121, 198);\">of</span>\n        <span style=\"color: rgb(189, 147, 249);\">Completed</span> <span>x</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span>cont</span> <span>x</span>\n        <span style=\"color: rgb(189, 147, 249);\">Effect</span> <span>name</span> <span>arguments</span> <span>cont</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span>\n            <span style=\"color: rgb(255, 121, 198);\">case</span> <span>findHandler</span> <span>name</span> <span>handler</span> <span style=\"color: rgb(255, 121, 198);\">of</span>\n                 <span style=\"color: rgb(189, 147, 249);\">Nothing</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span> <span style=\"color: rgb(189, 147, 249);\">Effect</span> <span>name</span> <span>arguments</span> <span>cont</span>\n                 <span style=\"color: rgb(189, 147, 249);\">Just</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span>params</span><span style=\"color: rgb(248, 248, 242);\">,</span> <span>body</span><span style=\"color: rgb(248, 248, 242);\">)</span> <span style=\"color: rgb(255, 121, 198);\">-&gt;</span>\n                     <span style=\"color: rgb(98, 114, 164);\">-- I'm handwaving some of the error handling away ^^</span>\n                     <span>eval</span> <span>env</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span>defineAll</span> <span style=\"color: rgb(248, 248, 242);\">(</span><span style=\"color: rgb(139, 233, 253);\">zip</span> <span>params</span> <span>arguments</span><span style=\"color: rgb(248, 248, 242);\">)</span> <span>env</span><span style=\"color: rgb(248, 248, 242);\">)</span> <span>body</span> <span>cont</span></code></pre>"}},{"type":"markdown","markdown":{"content":"And that's it! This should be pretty fast and it's also roughly how `ContT` implements its delimited continuation operations I think. What's nice about this is how handling effects in the host language works in almost the same way as handling them in flora itself so embedding programs is pretty nice."}},{"type":"markdown","markdown":{"content":"So to answer your question: this is *emitting* effects like in Haskell or OCaml.\nI'm guessing by \"consuming the handler\" you mean what Koka does where it passes the handler implementation along and then calls the right handler right at the call site of `perform`? I'm not sure how well that would work here since you also want to be able to handle effects from the host language.\nYou could pass in a handler, but that would limit its expressivity a little since the emitting approach doesn't need to know the set of valid effects up front."}}],"pinned":false,"commentsLocked":false,"sharesLocked":false,"singlePostPageUrl":"https://cohost.org/prophet/post/6243684-flora-s-effect-handl"}